<!DOCTYPE html>

<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

    <title>Enter PIN - King & Queen Voting</title>

    <meta name="api-base" content="/api">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" th:href="@{/styles.css}">

    <style>
        .pin-input {
            width: 44px;
            height: 44px;
            text-align: center;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 20px;
        }

        .pin-input--active {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
        }

        .keypad-key {
            transform: scale(1);
            transition: transform .12s ease;
        }

        .keypad-pressed {
            transform: scale(0.94);
        }

        .skeleton {
            background-color: #e5e7eb;
            animation: pulse 1.2s ease-in-out infinite;
        }

        .skeleton-text {
            height: 14px;
            border-radius: 7px;
        }

        .skeleton-rounded {
            border-radius: 9999px;
        }

        .skeleton-tile {
            border-radius: 12px;
            height: 44px;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.55;
            }

            100% {
                opacity: 1;
            }
        }
    </style>

</head>

<body class="bg-gray-50">

<!-- PIN Screen -->

<div class="min-h-screen gradient-bg flex items-center justify-center p-4">

    <div class="bg-white rounded-3xl p-6 md:p-12 max-w-md w-full card-shadow slide-in">

        <div class="text-center mb-6 md:mb-8">

            <div class="w-16 h-16 md:w-20 md:h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">

                <svg class="w-8 h-8 md:w-10 md:h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">

                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>

                </svg>

            </div>

            <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-2">Enter Your PIN</h3>

            <p class="text-sm md:text-base text-gray-600">Please enter your 5-digit PIN to continue</p>

        </div>


        <div class="flex justify-center gap-3 md:gap-4 mb-6 md:mb-8">

            <input type="password" maxlength="1" class="pin-input" id="pin1" readonly aria-label="PIN digit 1">

            <input type="password" maxlength="1" class="pin-input" id="pin2" readonly aria-label="PIN digit 2">

            <input type="password" maxlength="1" class="pin-input" id="pin3" readonly aria-label="PIN digit 3">

            <input type="password" maxlength="1" class="pin-input" id="pin4" readonly aria-label="PIN digit 4">

            <input type="password" maxlength="1" class="pin-input" id="pin5" readonly aria-label="PIN digit 5">

        </div>



        <div class="grid grid-cols-3 gap-2 md:gap-3 mb-4" id="pin-keypad">

            <button onclick="addPin('1')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">1</button>

            <button onclick="addPin('2')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">2</button>

            <button onclick="addPin('3')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">3</button>

            <button onclick="addPin('4')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">4</button>

            <button onclick="addPin('5')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">5</button>

            <button onclick="addPin('6')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">6</button>

            <button onclick="addPin('7')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">7</button>

            <button onclick="addPin('8')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">8</button>

            <button onclick="addPin('9')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">9</button>

            <button onclick="clearPin()" class="bg-red-100 hover:bg-red-200 text-red-600 font-semibold py-3 md:py-4 rounded-xl transition text-sm md:text-base">Clear</button>

            <button onclick="addPin('0')" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition">0</button>

            <button onclick="deletePin()" class="keypad-key bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 md:py-4 rounded-xl transition" aria-label="Delete digit">‚Üê</button>

        </div>



        <button type="button" onclick="handleContinue()" class="w-full gradient-bg text-white py-3 md:py-4 rounded-xl font-semibold hover:opacity-90 transition">

            Continue

        </button>

    </div>

</div>



<!-- Error Modal -->

<div id="error-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4 z-50">

    <div class="bg-white rounded-3xl p-8 max-w-md w-full card-shadow slide-in">

        <div class="text-center">

            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">

                <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">

                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>

                </svg>

            </div>

            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="error-title">Unable to continue</h3>

            <p class="text-gray-600 mb-6" id="error-message">The PIN you entered is incorrect. Please try again.</p>


            <button data-close-modal="error-modal" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90 transition">

                Try Again

            </button>

        </div>

    </div>

</div>



<div class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 hidden" id="pin-loading" aria-hidden="true">
    <div class="space-y-4 w-full max-w-xs">
        <div class="skeleton skeleton-rounded h-16 w-16 mx-auto"></div>
        <div class="skeleton skeleton-text w-3/4 mx-auto"></div>
        <div class="grid grid-cols-3 gap-3">
            <div class="skeleton skeleton-tile"></div>
            <div class="skeleton skeleton-tile"></div>
            <div class="skeleton skeleton-tile"></div>
        </div>

    </div>
</div>

<script src="/js/voting.js"></script>
<script>
    const pinInputs = ['pin1', 'pin2', 'pin3', 'pin4', 'pin5'].map(id => document.getElementById(id));
    const pinLoadingOverlay = document.getElementById('pin-loading');

    // Web Audio API for keypad sound
    let audioContext = null;
    function getAudioContext() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        return audioContext;
    }

    function playKeypadFeedback(btn) {
        if (btn) {
            btn.classList.add('keypad-pressed');
            setTimeout(() => btn.classList.remove('keypad-pressed'), 120);
        }
        try {
            const ctx = getAudioContext();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);
            oscillator.frequency.value = 1200;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.08);
            oscillator.start(ctx.currentTime);
            oscillator.stop(ctx.currentTime + 0.08);
        } catch (e) {}
    }

    function setActiveInput(target) {
        pinInputs.forEach((input) => input.classList.toggle('pin-input--active', input === target));
    }

    function firstEmpty() {
        return pinInputs.find(input => input.value === '') || pinInputs[pinInputs.length - 1];
    }

    function getEnteredPin() {
        return pinInputs.map(i => i.value).join('');
    }

    function addPin(digit) {
        const btn = event?.currentTarget;
        playKeypadFeedback(btn);
        const target = firstEmpty();
        if (!target) return;
        target.value = digit;
        setActiveInput(target);
        if (pinInputs.every(i => i.value !== '')) handleContinue();
    }

    function deletePin() {
        const btn = event?.currentTarget;
        playKeypadFeedback(btn);
        for (let i = pinInputs.length - 1; i >= 0; i--) {
            if (pinInputs[i].value !== '') {
                pinInputs[i].value = '';
                setActiveInput(pinInputs[i]);
                break;
            }
        }
    }

    function clearPin() {
        const btn = event?.currentTarget;
        playKeypadFeedback(btn);
        pinInputs.forEach(i => i.value = '');
        setActiveInput(pinInputs[0]);
    }

    function showError(message, title = 'Unable to continue') {
        document.getElementById('error-title').textContent = title;
        document.getElementById('error-message').textContent = message;
        document.getElementById('error-modal').classList.remove('hidden');
        clearPin();
    }

    document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-close-modal');
        const modal = document.getElementById(id);
        if (modal) modal.classList.add('hidden');
    }));

    async function handleContinue() {
        const pin = getEnteredPin();
        if (pin.length !== 5) {
            showError('Please enter your 5-digit PIN.');
            return;
        }
        pinLoadingOverlay.classList.remove('hidden');
        try {
            const result = await VotingApp.verifyPin(pin);
            if (!result.valid) {
                showError('The PIN you entered does not exist. Please try again.', 'Invalid PIN');
                return;
            }
            if (result.alreadyVoted) {
                showError('This PIN has already been used to vote. Please contact an admin if you believe this is an error.', 'Already voted');
                return;
            }
            VotingApp.savePin(pin);
            VotingApp.getDeviceId();
            const isAdmin = (typeof result.isAdmin !== 'undefined') ? result.isAdmin : (result.role === 'admin');
            window.location.assign(isAdmin ? '/admin-dashboard' : '/king-selection');
        } catch (err) {
            console.error('Error during verifyPin:', err);
            showError(err.message || 'Something went wrong while verifying your PIN.');
        } finally {
            pinLoadingOverlay.classList.add('hidden');
            window.scrollTo(0, 0);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        pinInputs.forEach((input, idx) => {
            input.dataset.index = idx;
            input.addEventListener('focus', () => input.blur());
        });
        setActiveInput(pinInputs[0]);
        setTimeout(() => window.scrollTo(0, 0), 0);
    });
</script>

</body>

</html>
