<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Success - King & Queen Voting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body class="bg-gray-50">
    <!-- Success Screen -->
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-md w-full card-shadow slide-in">
            <div class="text-center">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-4">Voting Successful!</h3>
                <p class="text-gray-600 mb-6">Your votes have been submitted successfully. Thank you for participating!</p>
                
                <div class="bg-gray-50 rounded-xl p-4 mb-6 text-left">
                    <p class="text-sm text-gray-600 mb-2">Your votes:</p>
                    <p class="font-semibold text-gray-800" id="voted-king">King: -</p>
                    <p class="font-semibold text-gray-800" id="voted-queen">Queen: -</p>
                    <p class="font-semibold text-gray-800" id="voted-prince">Prince: -</p>
                    <p class="font-semibold text-gray-800" id="voted-princess">Princess: -</p>
                    <p class="font-semibold text-gray-800" id="voted-couple">Best Couple: -</p>
                </div>
                
                <button onclick="resetVoting()" class="w-full gradient-bg text-white py-3 rounded-xl font-semibold hover:opacity-90 transition">
                    Return to Home
                </button>
            </div>
        </div>
    </div>

    <script>
        // Display vote information
        const selectedKing = JSON.parse(localStorage.getItem('selectedKing') || 'null');
        const selectedQueen = JSON.parse(localStorage.getItem('selectedQueen') || 'null');
        const selectedPrince = JSON.parse(localStorage.getItem('selectedPrince') || 'null');
        const selectedPrincess = JSON.parse(localStorage.getItem('selectedPrincess') || 'null');
        const selectedCouple = JSON.parse(localStorage.getItem('selectedCouple') || 'null');

        // Also read the fallback candidate numbers if the full object isn't stored
        const kingSelection = localStorage.getItem('kingSelection');
        const queenSelection = localStorage.getItem('queenSelection');
        const princeSelection = localStorage.getItem('princeSelection');
        const princessSelection = localStorage.getItem('princessSelection');
        const coupleSelection = localStorage.getItem('coupleSelection');

        document.getElementById('voted-king').textContent = `King: ${ (selectedKing && selectedKing.name) ? selectedKing.name : (kingSelection ? ('#' + kingSelection) : 'Not selected') }`;
        document.getElementById('voted-queen').textContent = `Queen: ${ (selectedQueen && selectedQueen.name) ? selectedQueen.name : (queenSelection ? ('#' + queenSelection) : 'Not selected') }`;
        document.getElementById('voted-prince').textContent = `Prince: ${ (selectedPrince && selectedPrince.name) ? selectedPrince.name : (princeSelection ? ('#' + princeSelection) : 'Not selected') }`;
        document.getElementById('voted-princess').textContent = `Princess: ${ (selectedPrincess && selectedPrincess.name) ? selectedPrincess.name : (princessSelection ? ('#' + princessSelection) : 'Not selected') }`;
        document.getElementById('voted-couple').textContent = `Best Couple: ${ (selectedCouple && selectedCouple.name) ? selectedCouple.name : (coupleSelection ? ('#' + coupleSelection) : 'Not selected') }`;

        // If names are not available in localStorage, try fetching from the server by candidate number
        async function fetchMissingNames() {
            try {
                const toFetch = [];
                if (!(selectedKing && selectedKing.name) && kingSelection) toFetch.push({cat: 'king', num: kingSelection, elId: 'voted-king', prefix: 'King: '});
                if (!(selectedQueen && selectedQueen.name) && queenSelection) toFetch.push({cat: 'queen', num: queenSelection, elId: 'voted-queen', prefix: 'Queen: '});
                if (!(selectedPrince && selectedPrince.name) && princeSelection) toFetch.push({cat: 'prince', num: princeSelection, elId: 'voted-prince', prefix: 'Prince: '});
                if (!(selectedPrincess && selectedPrincess.name) && princessSelection) toFetch.push({cat: 'princess', num: princessSelection, elId: 'voted-princess', prefix: 'Princess: '});
                if (!(selectedCouple && selectedCouple.name) && coupleSelection) toFetch.push({cat: 'couple', num: coupleSelection, elId: 'voted-couple', prefix: 'Best Couple: '});

                for (const item of toFetch) {
                    try {
                        // Ensure category path matches server expectations
                        const categoryPath = String(item.cat).toUpperCase();
                        const r = await fetch(`/api/candidates/${categoryPath}`);
                        if (!r.ok) continue;
                        const list = await r.json();
                        const found = (Array.isArray(list) ? list : []).find(c => String(c.candidateNumber) === String(item.num) || String(c.id) === String(item.num));
                        if (found && found.name) {
                            const el = document.getElementById(item.elId);
                            if (el) el.textContent = item.prefix + found.name;
                        }
                    } catch (e) {
                        // ignore fetch errors for individual categories
                        console.warn('Could not fetch candidates for', item.cat, e);
                    }
                }
            } catch (e) {
                console.warn('fetchMissingNames error', e);
            }
        }

        // invoke
        fetchMissingNames().catch(e => console.warn('fetchMissingNames error', e));

        const LANDING_URL = '/';

        function resetVoting() {
            // Optionally clear selections here when explicitly returning home
            localStorage.removeItem('kingSelection');
            localStorage.removeItem('selectedKing');
            localStorage.removeItem('queenSelection');
            localStorage.removeItem('selectedQueen');
            localStorage.removeItem('princeSelection');
            localStorage.removeItem('selectedPrince');
            localStorage.removeItem('princessSelection');
            localStorage.removeItem('selectedPrincess');
            localStorage.removeItem('coupleSelection');
            localStorage.removeItem('selectedCouple');
            window.location.href = LANDING_URL;
        }
    </script>
</body>
</html>
